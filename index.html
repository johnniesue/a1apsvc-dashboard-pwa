<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>A‚Äë1APSVC Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin:0; background:#0f172a; color:#e5e7eb; }
    header { padding:16px 20px; background:#111827; border-bottom:1px solid #1f2937; display:flex; align-items:center; gap:10px;}
    header h1 { margin:0; font-size:18px; font-weight:600; }
    main { padding:20px; }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .card { background:#111827; border:1px solid #1f2937; border-radius:14px; padding:16px; }
    .stat-number { font-size:28px; font-weight:700; margin-bottom:6px; }
    .muted { color:#94a3b8; font-size:14px; }
    footer { border-top:1px solid #1f2937; padding:14px 20px; font-size:13px; color:#94a3b8;}
    .ok { color:#10b981; } .warn { color:#f59e0b; } .err { color:#ef4444; }
  </style>

  <!-- Use compat builds + add a query param (?v=) to break caches when you update -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js?v=4" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js?v=4" defer></script>
</head>
<body>
  <header>
    <h1>A‚Äë1 Affordable Plumbing Services ‚Äî Dashboard</h1>
  </header>

  <main>
    <div class="grid">
      <div class="card">
        <div class="stat-number" id="todayCount">0</div>
        <div class="muted">Today‚Äôs Jobs</div>
      </div>
      <div class="card">
        <div class="stat-number" id="weekCount">0</div>
        <div class="muted">This Week</div>
      </div>
      <div class="card">
        <div class="stat-number" id="avgJobValue">$0</div>
        <div class="muted">Average Job Value</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="muted">Console status:</div>
      <ul class="muted" style="margin:8px 0 0; padding-left:18px; line-height:1.5">
        <li>üîß Using <strong>compat</strong> SDKs (no modular import errors)</li>
        <li>üßπ If you still see old errors, hard refresh (Ctrl+F5) or try private window</li>
        <li>üß© If Firestore says you need an index, click the link it shows to create one</li>
      </ul>
    </div>
  </main>

  <footer>¬© A‚Äë1 Affordable Plumbing Services</footer>

  <!-- Your app code (with cache-busting param) -->
  <script defer>
  // Wrap in onload so compat scripts are ready
  window.addEventListener('load', async () => {
    try {
      console.log('üöÄ Starting dashboard boot‚Ä¶');

      // ‚úÖ Your real Firebase config (you said this is now correct)
      const firebaseConfig = {
        apiKey: "AIzaSyDeVLmKQXCMN_JZNwFL9OhfCQKVRHsVhY4",
        authDomain: "a1-customer-dashboard.firebaseapp.com",
        projectId: "a1-customer-dashboard",
        storageBucket: "a1-customer-dashboard.appspot.com",
        messagingSenderId: "981606789719",
        appId: "1:981606789719:web:327592a2cefa2536bda912"
      };

      // Init (compat)
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      console.log('‚úÖ Firebase initialized (compat)');

      // Helpers for date ranges
      const startOfDay = (d = new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0, 0, 0, 0);
      const endOfDay   = (d = new Date()) => new Date(d.getFullYear(), d.getMonth(), d.getDate(), 23, 59, 59, 999);
      const startOfWeek = (d = new Date()) => {
        const day = d.getDay();                // 0=Sun..6=Sat
        const diff = d.getDate() - day + 1;    // Monday as start
        return startOfDay(new Date(d.getFullYear(), d.getMonth(), diff));
      };
      const endOfWeek = (d = new Date()) => {
        const s = startOfWeek(d);
        const e = new Date(s); e.setDate(s.getDate() + 6);
        return endOfDay(e);
      };

      // üîÑ Today‚Äôs Jobs from ServiceRequest.scheduledAt (Timestamp)
      console.log('üîÑ Attempting to get today\'s jobs from Firestore‚Ä¶');
      const tStart = firebase.firestore.Timestamp.fromDate(startOfDay());
      const tEnd   = firebase.firestore.Timestamp.fromDate(endOfDay());
      // if you get an index error, create the index from Firestore‚Äôs link in the console
      const todaySnap = await db.collection('jobs')
        .where('scheduledAt', '>=', tStart)
        .where('scheduledAt', '<=', tEnd)
        .get();
      document.getElementById('todayCount').textContent = todaySnap.size;
      console.log(`‚úÖ Today‚Äôs jobs: ${todaySnap.size}`);

      // üîÑ This Week‚Äôs Jobs
      console.log('üîÑ Attempting to get this week\'s jobs from Firestore‚Ä¶');
      const wStart = firebase.firestore.Timestamp.fromDate(startOfWeek());
      const wEnd   = firebase.firestore.Timestamp.fromDate(endOfWeek());
      const weekSnap = await db.collection('ServiceRequest')
        .where('scheduledAt', '>=', wStart)
        .where('scheduledAt', '<=', wEnd)
        .get();
      document.getElementById('weekCount').textContent = weekSnap.size;
      console.log(`‚úÖ This week‚Äôs jobs: ${weekSnap.size}`);

      // üíµ Average Job Value (from Invoice.amount number field)
      console.log('üîÑ Attempting to compute average job value from invoices‚Ä¶');
      const invSnap = await db.collection('Invoice').get();
      let total = 0; let count = 0;
      invSnap.forEach(doc => {
        const amt = Number(doc.data().amount || 0);
        if (!Number.isNaN(amt) && amt > 0) { total += amt; count++; }
      });
      const avg = count ? (total / count) : 0;
      document.getElementById('avgJobValue').textContent = `$${avg.toFixed(0).toLocaleString?.() || Math.round(avg)}`;
      console.log(`‚úÖ Average job value from ${count} invoice(s): $${avg.toFixed(2)}`);

    } catch (err) {
      console.error('‚ùå Dashboard error:', err);
      // Quick visual hint if something blows up
      const el = document.querySelector('#todayCount');
      if (el) el.innerHTML = '<span class="err">Error</span>';
    }
  });
  </script>
</body>
</html>
