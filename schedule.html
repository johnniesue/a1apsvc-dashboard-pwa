<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A-1APSVC Scheduling</title>
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a365d;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
        }

        .logo.hidden {
            display: none;
        }

        .nav-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .nav-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            background: #4299e1;
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .scheduling-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .scheduling-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .scheduling-title h1 {
            font-size: 2rem;
            color: #1a365d;
        }

        .scheduling-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #4299e1;
            color: white;
        }

        .btn-primary:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .calendar-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .calendar-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .calendar-nav button {
            padding: 0.5rem;
            border: none;
            border-radius: 6px;
            background: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-nav button:hover {
            background: #cbd5e0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day-header {
            background: #4a5568;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 0.5rem;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #f7fafc;
        }

        .calendar-day.other-month {
            background: #f7fafc;
            color: #a0aec0;
        }

        .calendar-day.today {
            background: #ebf8ff;
            border: 2px solid #4299e1;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .appointment {
            background: #4299e1;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .appointment:hover {
            background: #3182ce;
        }

        .appointment.chris {
            background: #48bb78;
        }

        .appointment.kian {
            background: #ed8936;
        }

        .appointment.unassigned {
            background: #a0aec0;
        }

        .appointment.en-route {
            background: #9f7aea;
        }

        .appointment.completed {
            background: #38a169;
        }

        .technician-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .tech-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .tech-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tech-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4299e1, #3182ce);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .tech-info h3 {
            margin: 0;
            color: #1a365d;
        }

        .tech-status {
            font-size: 0.9rem;
            color: #4a5568;
        }

        .tech-appointments {
            space-y: 0.5rem;
        }

        .tech-appointment {
            background: #f7fafc;
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid #4299e1;
            margin-bottom: 0.5rem;
        }

        .appointment-time {
            font-weight: 600;
            color: #1a365d;
        }

        .appointment-customer {
            color: #4a5568;
            margin: 0.25rem 0;
        }

        .appointment-status {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-scheduled {
            background: #bee3f8;
            color: #2b6cb0;
        }

        .status-en-route {
            background: #e9d8fd;
            color: #6b46c1;
        }

        .status-in-progress {
            background: #fef5e7;
            color: #c05621;
        }

        .status-completed {
            background: #c6f6d5;
            color: #22543d;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1a365d;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #a0aec0;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4299e1;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .mobile-status-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(100%);
            transition: transform 0.3s;
            z-index: 200;
        }

        .mobile-status-panel.show {
            transform: translateY(0);
        }

        .status-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
        }

        .status-btn {
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .status-btn.en-route {
            background: #9f7aea;
            color: white;
        }

        .status-btn.in-progress {
            background: #ed8936;
            color: white;
        }

        .status-btn.completed {
            background: #48bb78;
            color: white;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .scheduling-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .calendar-day {
                min-height: 80px;
                padding: 0.25rem;
            }

            .technician-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-section">
            <img id="headerLogo" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%234299e1'/%3E%3Ctext x='50' y='60' text-anchor='middle' fill='white' font-size='24' font-weight='bold'%3EA1%3C/text%3E%3C/svg%3E" alt="A-1APSVC Logo" class="logo hidden">
            <div>
                <h1 style="font-size: 1.5rem; margin: 0;">A-1APSVC Scheduling</h1>
                <p style="margin: 0; color: #64748b;">Calendar & Appointment Management</p>
            </div>
        </div>
        <div class="nav-buttons">
            <a href="index.html" class="nav-btn">üè† Dashboard</a>
            <a href="reports.html" class="nav-btn">üìä Reports</a>
            <a href="customers.html" class="nav-btn">üë• Customers</a>
        </div>
    </div>

    <div class="container">
        <div class="scheduling-header">
            <div class="scheduling-title">
                <span style="font-size: 2rem;">üìÖ</span>
                <h1>Scheduling Dashboard</h1>
            </div>
            <p style="color: #64748b; margin-bottom: 1.5rem;">Manage appointments, assign technicians, and track service progress</p>
            <div class="scheduling-controls">
                <button class="btn btn-primary" onclick="showNewAppointmentModal()">
                    ‚ûï New Appointment
                </button>
                <button class="btn btn-secondary" onclick="showTechStatusPanel()">
                    üì± Tech Status Update
                </button>
                <button class="btn btn-secondary" onclick="refreshSchedule()">
                    üîÑ Refresh
                </button>
                <select class="form-select" style="width: auto;" onchange="filterByTechnician(this.value)">
                    <option value="">All Technicians</option>
                    <option value="chris">Chris Crabtree</option>
                    <option value="kian">Kian Crabtree</option>
                    <option value="unassigned">Unassigned</option>
                </select>
            </div>
        </div>

        <div class="technician-panel">
            <div class="tech-card">
                <div class="tech-header">
                    <div class="tech-avatar">CC</div>
                    <div class="tech-info">
                        <h3>Chris Crabtree</h3>
                        <div class="tech-status" id="chris-status">Available</div>
                    </div>
                </div>
                <div class="tech-appointments" id="chris-appointments">
                    <!-- Chris's appointments will be populated here -->
                </div>
            </div>

            <div class="tech-card">
                <div class="tech-header">
                    <div class="tech-avatar" style="background: linear-gradient(135deg, #ed8936, #c05621);">KC</div>
                    <div class="tech-info">
                        <h3>Kian Crabtree</h3>
                        <div class="tech-status" id="kian-status">Available</div>
                    </div>
                </div>
                <div class="tech-appointments" id="kian-appointments">
                    <!-- Kian's appointments will be populated here -->
                </div>
            </div>
        </div>

        <div class="calendar-container">
            <div class="calendar-header">
                <h2 id="calendar-month-year">December 2024</h2>
                <div class="calendar-nav">
                    <button onclick="previousMonth()">‚Äπ</button>
                    <button onclick="today()">Today</button>
                    <button onclick="nextMonth()">‚Ä∫</button>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                <!-- Calendar will be populated here -->
            </div>
        </div>
    </div>

    <!-- New Appointment Modal -->
    <div id="appointmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Appointment</h2>
                <button class="close-btn" onclick="closeAppointmentModal()">&times;</button>
            </div>
            <form id="appointmentForm">
                <div class="form-group">
                    <label class="form-label">Customer *</label>
                    <select class="form-select" id="customer-select" required>
                        <option value="">Select a customer...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Date *</label>
                    <input type="date" class="form-input" id="appointment-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Time *</label>
                    <input type="time" class="form-input" id="appointment-time" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Duration (hours)</label>
                    <select class="form-select" id="appointment-duration">
                        <option value="1">1 hour</option>
                        <option value="2" selected>2 hours</option>
                        <option value="3">3 hours</option>
                        <option value="4">4 hours</option>
                        <option value="6">6 hours</option>
                        <option value="8">8 hours</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Assign Technician</label>
                    <select class="form-select" id="technician-select">
                        <option value="">Unassigned</option>
                        <option value="chris">Chris Crabtree</option>
                        <option value="kian">Kian Crabtree</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Service Type</label>
                    <select class="form-select" id="service-type">
                        <option value="repair">Repair</option>
                        <option value="installation">Installation</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="inspection">Inspection</option>
                        <option value="emergency">Emergency</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="appointment-notes" placeholder="Service details, special instructions, etc."></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeAppointmentModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Appointment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Mobile Status Update Panel -->
    <div id="mobileStatusPanel" class="mobile-status-panel">
        <div style="text-align: center; margin-bottom: 1rem;">
            <h3 id="status-appointment-title">Update Appointment Status</h3>
            <p id="status-appointment-details" style="color: #64748b;"></p>
        </div>
        <div class="status-buttons">
            <button class="status-btn en-route" onclick="updateAppointmentStatus('en-route')">
                üöó En Route
            </button>
            <button class="status-btn in-progress" onclick="updateAppointmentStatus('in-progress')">
                üîß In Progress
            </button>
            <button class="status-btn completed" onclick="updateAppointmentStatus('completed')">
                ‚úÖ Completed
            </button>
            <button class="status-btn" style="background: #e2e8f0; color: #4a5568;" onclick="hideMobileStatusPanel()">
                Cancel
            </button>
        </div>
    </div>

    <script src="logo-manager.js"></script>
    <script src="customer-data.js"></script>
    <script src="technician-manager.js"></script>
    <script>
        // Enhanced Scheduling System with Customer and Technician Integration
        class SchedulingManager {
            constructor() {
                this.appointments = this.loadAppointments();
                this.customers = this.loadCustomers();
                this.currentDate = new Date();
                this.selectedAppointment = null;
                this.init();
            }

            init() {
                // Wait for customer data to be initialized
                setTimeout(() => {
                    this.populateCustomerSelect();
                    this.renderCalendar();
                    this.renderTechnicianAppointments();
                    this.updateTechnicianStatus();
                }, 100);
            }

            loadAppointments() {
                const saved = localStorage.getItem('a1apsvc-appointments');
                if (saved) {
                    return JSON.parse(saved);
                }
                
                // Sample appointments with real customer data
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(today.getDate() + 1);
                
                return [
                    {
                        id: 'apt_001',
                        customerId: 'cust_001',
                        customerName: 'Frank Reed',
                        date: today.toISOString().split('T')[0],
                        time: '09:00',
                        duration: 2,
                        technician: 'chris',
                        serviceType: 'repair',
                        status: 'scheduled',
                        notes: 'Kitchen sink leak repair - customer reported dripping under sink',
                        address: 'Address to be confirmed',
                        customerPhone: '(917) 000-0000',
                        customerEmail: 'frankpr1980@gmail.com'
                    },
                    {
                        id: 'apt_002',
                        customerId: 'cust_004',
                        customerName: 'Ruth Young',
                        date: today.toISOString().split('T')[0],
                        time: '14:00',
                        duration: 3,
                        technician: 'kian',
                        serviceType: 'installation',
                        status: 'en-route',
                        notes: 'Install new water heater - 50 gallon gas unit',
                        address: 'Address to be confirmed',
                        customerPhone: '(972) 000-0000',
                        customerEmail: 'rayoung258@yahoo.com'
                    },
                    {
                        id: 'apt_003',
                        customerId: 'cust_005',
                        customerName: 'Pierce Fonville',
                        date: tomorrow.toISOString().split('T')[0],
                        time: '10:00',
                        duration: 1,
                        technician: '',
                        serviceType: 'inspection',
                        status: 'scheduled',
                        notes: 'Routine plumbing inspection for Rentavations property',
                        address: 'Address to be confirmed',
                        customerPhone: '(817) 000-0000',
                        customerEmail: 'pierce@rentavations.com'
                    }
                ];
            }

            loadCustomers() {
                // Load customers from the customer management system
                if (typeof initializeCustomerData === 'function') {
                    return initializeCustomerData();
                }
                
                const saved = localStorage.getItem('a1apsvc-customers');
                if (saved) {
                    return JSON.parse(saved);
                }
                
                return [];
            }

            saveAppointments() {
                localStorage.setItem('a1apsvc-appointments', JSON.stringify(this.appointments));
            }

            populateCustomerSelect() {
                const select = document.getElementById('customer-select');
                select.innerHTML = '<option value="">Select a customer...</option>';
                
                this.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = `${customer.firstName} ${customer.lastName}`;
                    if (customer.address) {
                        option.textContent += ` - ${customer.address}`;
                    }
                    select.appendChild(option);
                });
            }

            createAppointment(appointmentData) {
                const customer = this.customers.find(c => c.id === appointmentData.customerId);
                const appointment = {
                    id: 'apt_' + Date.now(),
                    customerId: appointmentData.customerId,
                    customerName: customer ? `${customer.firstName} ${customer.lastName}` : 'Unknown Customer',
                    date: appointmentData.date,
                    time: appointmentData.time,
                    duration: parseInt(appointmentData.duration),
                    technician: appointmentData.technician,
                    serviceType: appointmentData.serviceType,
                    status: 'scheduled',
                    notes: appointmentData.notes,
                    address: customer ? customer.address || 'Address to be confirmed' : 'No address',
                    customerPhone: customer ? customer.mobilePhone || customer.homePhone || 'No phone' : 'No phone',
                    customerEmail: customer ? customer.email || 'No email' : 'No email'
                };

                this.appointments.push(appointment);
                this.saveAppointments();
                
                // Notify technician manager if technician is assigned
                if (appointment.technician && typeof window.technicianManager !== 'undefined') {
                    window.technicianManager.assignAppointment(appointment.technician, appointment.id, appointment);
                }
                
                this.renderCalendar();
                this.renderTechnicianAppointments();
                this.updateTechnicianStatus();
                
                // Show success notification
                this.showNotification(`Appointment created for ${appointment.customerName}`, 'success');
            }

            updateAppointmentStatus(appointmentId, status) {
                const appointment = this.appointments.find(apt => apt.id === appointmentId);
                if (appointment) {
                    appointment.status = status;
                    this.saveAppointments();
                    
                    // Notify technician manager
                    if (appointment.technician && typeof window.technicianManager !== 'undefined') {
                        window.technicianManager.updateTechnicianStatus(appointment.technician, status, appointmentId);
                    }
                    
                    this.renderCalendar();
                    this.renderTechnicianAppointments();
                    this.updateTechnicianStatus();
                }
            }

            getAppointmentById(appointmentId) {
                return this.appointments.find(apt => apt.id === appointmentId);
            }

            assignTechnician(appointmentId, techId) {
                const appointment = this.appointments.find(apt => apt.id === appointmentId);
                if (appointment) {
                    appointment.technician = techId;
                    this.saveAppointments();
                    
                    // Notify technician manager
                    if (typeof window.technicianManager !== 'undefined') {
                        window.technicianManager.assignAppointment(techId, appointmentId, appointment);
                    }
                    
                    this.renderCalendar();
                    this.renderTechnicianAppointments();
                    this.updateTechnicianStatus();
                }
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : '#4299e1'};
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 1000;
                    max-width: 300px;
                    font-weight: 500;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.textContent = message;

                document.body.appendChild(notification);

                // Remove after 4 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 4000);
            }

            renderCalendar() {
                const grid = document.getElementById('calendar-grid');
                const monthYear = document.getElementById('calendar-month-year');
                
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                
                monthYear.textContent = new Intl.DateTimeFormat('en-US', { 
                    month: 'long', 
                    year: 'numeric' 
                }).format(this.currentDate);

                // Clear grid
                grid.innerHTML = '';

                // Add day headers
                const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                dayHeaders.forEach(day => {
                    const header = document.createElement('div');
                    header.className = 'calendar-day-header';
                    header.textContent = day;
                    grid.appendChild(header);
                });

                // Get first day of month and number of days
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());

                // Generate calendar days
                for (let i = 0; i < 42; i++) {
                    const date = new Date(startDate);
                    date.setDate(startDate.getDate() + i);
                    
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    
                    if (date.getMonth() !== month) {
                        dayElement.classList.add('other-month');
                    }
                    
                    if (this.isToday(date)) {
                        dayElement.classList.add('today');
                    }

                    const dayNumber = document.createElement('div');
                    dayNumber.className = 'day-number';
                    dayNumber.textContent = date.getDate();
                    dayElement.appendChild(dayNumber);

                    // Add appointments for this day
                    const dayAppointments = this.getAppointmentsForDate(date);
                    dayAppointments.forEach(apt => {
                        const aptElement = document.createElement('div');
                        aptElement.className = `appointment ${apt.technician || 'unassigned'} ${apt.status}`;
                        aptElement.textContent = `${apt.time} ${apt.customerName}`;
                        aptElement.onclick = () => this.showAppointmentDetails(apt);
                        dayElement.appendChild(aptElement);
                    });

                    dayElement.onclick = () => this.selectDate(date);
                    grid.appendChild(dayElement);
                }
            }

            renderTechnicianAppointments() {
                this.renderTechAppointments('chris', 'chris-appointments');
                this.renderTechAppointments('kian', 'kian-appointments');
            }

            renderTechAppointments(techId, containerId) {
                const container = document.getElementById(containerId);
                const today = new Date().toISOString().split('T')[0];
                const techAppointments = this.appointments.filter(apt => 
                    apt.technician === techId && apt.date >= today
                ).sort((a, b) => {
                    if (a.date === b.date) {
                        return a.time.localeCompare(b.time);
                    }
                    return a.date.localeCompare(b.date);
                });

                container.innerHTML = '';

                if (techAppointments.length === 0) {
                    container.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 1rem;">No upcoming appointments</p>';
                    return;
                }

                techAppointments.forEach(apt => {
                    const aptElement = document.createElement('div');
                    aptElement.className = 'tech-appointment';
                    aptElement.innerHTML = `
                        <div class="appointment-time">${this.formatDate(apt.date)} at ${apt.time}</div>
                        <div class="appointment-customer">${apt.customerName}</div>
                        <div style="font-size: 0.8rem; color: #64748b; margin: 0.25rem 0;">${apt.serviceType} - ${apt.duration}h</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                            <span class="appointment-status status-${apt.status}">${this.formatStatus(apt.status)}</span>
                            <button class="btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" onclick="schedulingManager.showMobileStatusPanel('${apt.id}')">
                                Update Status
                            </button>
                        </div>
                    `;
                    container.appendChild(aptElement);
                });
            }

            updateTechnicianStatus() {
                const chrisStatus = document.getElementById('chris-status');
                const kianStatus = document.getElementById('kian-status');
                
                const today = new Date().toISOString().split('T')[0];
                const now = new Date();
                const currentTime = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                // Check Chris's status
                const chrisCurrentApt = this.appointments.find(apt => 
                    apt.technician === 'chris' && 
                    apt.date === today && 
                    apt.status === 'in-progress'
                );
                
                if (chrisCurrentApt) {
                    chrisStatus.textContent = `Working - ${chrisCurrentApt.customerName}`;
                    chrisStatus.style.color = '#ed8936';
                } else {
                    const chrisEnRoute = this.appointments.find(apt => 
                        apt.technician === 'chris' && 
                        apt.date === today && 
                        apt.status === 'en-route'
                    );
                    
                    if (chrisEnRoute) {
                        chrisStatus.textContent = `En Route - ${chrisEnRoute.customerName}`;
                        chrisStatus.style.color = '#9f7aea';
                    } else {
                        chrisStatus.textContent = 'Available';
                        chrisStatus.style.color = '#48bb78';
                    }
                }

                // Check Kian's status
                const kianCurrentApt = this.appointments.find(apt => 
                    apt.technician === 'kian' && 
                    apt.date === today && 
                    apt.status === 'in-progress'
                );
                
                if (kianCurrentApt) {
                    kianStatus.textContent = `Working - ${kianCurrentApt.customerName}`;
                    kianStatus.style.color = '#ed8936';
                } else {
                    const kianEnRoute = this.appointments.find(apt => 
                        apt.technician === 'kian' && 
                        apt.date === today && 
                        apt.status === 'en-route'
                    );
                    
                    if (kianEnRoute) {
                        kianStatus.textContent = `En Route - ${kianEnRoute.customerName}`;
                        kianStatus.style.color = '#9f7aea';
                    } else {
                        kianStatus.textContent = 'Available';
                        kianStatus.style.color = '#48bb78';
                    }
                }
            }

            showMobileStatusPanel(appointmentId) {
                const appointment = this.appointments.find(apt => apt.id === appointmentId);
                if (!appointment) return;

                this.selectedAppointment = appointment;
                
                document.getElementById('status-appointment-title').textContent = appointment.customerName;
                document.getElementById('status-appointment-details').textContent = 
                    `${this.formatDate(appointment.date)} at ${appointment.time} - ${appointment.serviceType}`;
                
                document.getElementById('mobileStatusPanel').classList.add('show');
            }

            hideMobileStatusPanel() {
                document.getElementById('mobileStatusPanel').classList.remove('show');
                this.selectedAppointment = null;
            }

            updateSelectedAppointmentStatus(status) {
                if (this.selectedAppointment) {
                    this.updateAppointmentStatus(this.selectedAppointment.id, status);
                    this.hideMobileStatusPanel();
                }
            }

            // Utility methods
            isToday(date) {
                const today = new Date();
                return date.toDateString() === today.toDateString();
            }

            getAppointmentsForDate(date) {
                const dateString = date.toISOString().split('T')[0];
                return this.appointments.filter(apt => apt.date === dateString);
            }

            formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00');
                return new Intl.DateTimeFormat('en-US', { 
                    weekday: 'short',
                    month: 'short', 
                    day: 'numeric' 
                }).format(date);
            }

            formatStatus(status) {
                const statusMap = {
                    'scheduled': 'Scheduled',
                    'en-route': 'En Route',
                    'in-progress': 'In Progress',
                    'completed': 'Completed'
                };
                return statusMap[status] || status;
            }

            selectDate(date) {
                const dateString = date.toISOString().split('T')[0];
                document.getElementById('appointment-date').value = dateString;
                showNewAppointmentModal();
            }

            previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                this.renderCalendar();
            }

            nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                this.renderCalendar();
            }

            goToToday() {
                this.currentDate = new Date();
                this.renderCalendar();
            }
        }

        // Global functions
        function showNewAppointmentModal() {
            document.getElementById('appointmentModal').classList.add('show');
        }

        function closeAppointmentModal() {
            document.getElementById('appointmentModal').classList.remove('show');
            document.getElementById('appointmentForm').reset();
        }

        function showTechStatusPanel() {
            // Show a list of today's appointments for quick status updates
            const today = new Date().toISOString().split('T')[0];
            const todayAppointments = schedulingManager.appointments.filter(apt => apt.date === today);
            
            if (todayAppointments.length > 0) {
                schedulingManager.showMobileStatusPanel(todayAppointments[0].id);
            } else {
                alert('No appointments scheduled for today');
            }
        }

        function refreshSchedule() {
            schedulingManager.renderCalendar();
            schedulingManager.renderTechnicianAppointments();
            schedulingManager.updateTechnicianStatus();
        }

        function filterByTechnician(techId) {
            // This would filter the calendar view by technician
            // For now, we'll just refresh the view
            refreshSchedule();
        }

        function previousMonth() {
            schedulingManager.previousMonth();
        }

        function nextMonth() {
            schedulingManager.nextMonth();
        }

        function today() {
            schedulingManager.goToToday();
        }

        function updateAppointmentStatus(status) {
            schedulingManager.updateSelectedAppointmentStatus(status);
        }

        function hideMobileStatusPanel() {
            schedulingManager.hideMobileStatusPanel();
        }

        // Form submission
        document.getElementById('appointmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                customerId: document.getElementById('customer-select').value,
                date: document.getElementById('appointment-date').value,
                time: document.getElementById('appointment-time').value,
                duration: document.getElementById('appointment-duration').value,
                technician: document.getElementById('technician-select').value,
                serviceType: document.getElementById('service-type').value,
                notes: document.getElementById('appointment-notes').value
            };

            if (!formData.customerId || !formData.date || !formData.time) {
                alert('Please fill in all required fields');
                return;
            }

            schedulingManager.createAppointment(formData);
            closeAppointmentModal();
        });

        // Initialize the scheduling system
        let schedulingManager;
        
        window.addEventListener('load', function() {
            // Load customer data if available
            if (typeof window.preloadedCustomers === 'undefined') {
                // Try to load from customer management system
                const savedCustomers = localStorage.getItem('a1apsvc-customers');
                if (savedCustomers) {
                    window.preloadedCustomers = JSON.parse(savedCustomers);
                }
            }
            
            schedulingManager = new SchedulingManager();
        });
    </script>
</body>
</html>

